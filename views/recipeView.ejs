<!-- STYLESHEET -->
<link rel="stylesheet" href="/css/recipeView.css">

<!-- SECTION -->
<section>

    <!-- ì „ì²´ í‹€ -->
    <div class="section-box">

        <!-- ì™¼ìª½ ì‚¬ì´ë“œë°”, ì‚¬ì‹¤ìƒ ì“¸ëª¨x -->
        <div class="sidebar-section">
            <div class="sidebar-box-left">
                <a>â–²</a>
                <a>â–¼</a>
                <a>ğŸ—¨ï¸</a>
            </div>
        </div>

        <!-- ê¸€ ë³´ì—¬ì§€ëŠ” ê°€ìš´ë° í™”ë©´ div -->
        <div class="recipe-view-section">

            <!-- ê¸€ ë¶€ë¶„ -->
            <div class="post-section">

                <!-- ê¸€ ì œëª© ë¶€ë¶„ -->
                <div class="post-title">
                    <!-- ê¸€ ì œëª© ë¶ˆëŸ¬ì˜¤ê¸° -->
                    <%= data.title %>
                </div>

                <!-- ì‘ì„±ì ~ ëŒ“ê¸€ ë¶€ë¶„ -->
                <div class="post-info-box">

                    <!-- ì‘ì„±ì ì´ë¦„ê³¼ ë‚ ì§œ -->
                    <ul class="post-info-first">
                        <li class="writer-name">
                            <!-- ì‘ì„±ì ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸° -->
                            <%= data.writer_id %>
                            <!--  operator_id -->
                        </li>
                        <li class="write-date">
                            <!-- ì‘ì„±ì¼ ë¶ˆëŸ¬ì˜¤ê¸° -->
                            <%= data.createdAt.toISOString().split('T')[0] %>
                            <%= data.createdAt.toISOString().split('T')[1].slice(0,5) %>
                        </li>
                    </ul>

                    <!-- ì¡°íšŒìˆ˜, ì¶”ì²œ, ëŒ“ê¸€ -->
                    <ul class="post-info-second">
                        <li class="post-views">
                            ì¡°íšŒ
                            <span>
                                <!-- ì¡°íšŒìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° -->
                                <%= data.viewCount %>                            
                            </span>
                        </li>
                        <li class="post-ups">
                            ì¶”ì²œ 
                            <span id="like">
                                <!-- ìœ„ì— ì•„ì´ë”” ì‚­ì œ âš ï¸âš ï¸âš ï¸ì¶”ì²œìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° -->
                                <%= likeInfo.likeCount %>
                            </span>
                        </li>
                        <li class="post-com-num">
                            ëŒ“ê¸€
                            <!-- ìˆ«ì í´ë¦­ ì‹œ ëŒ“ê¸€ ì°½ ë¶€ë¶„ìœ¼ë¡œ ì´ë™ -->
                            <a href="#comment">
                                <span>
                                    <!-- ëŒ“ê¸€ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° -->
                                    <%= commentInfo.count %>
                                </span>
                            </a>
                        </li>
                    </ul>
                </div>

            <!-- íƒœê·¸ -->
            <div class="recipe-view-tag">
                <% tagList.forEach((name, index)=> {%> 
                    <a a href="/recipe/list/<%= name %>">#<%=name%></a>
                <% }) %>
            </div>

                    <!-- ì¿¡íƒ€ì„, ë‚œì´ë„ -->
                    <div class="recipe-view-timelevel">

                        <!-- ì¿¡íƒ€ì„ -->
                        <div class="recipe-view-cooktime">
                            â±ï¸ì¿¡íƒ€ì„ ì•½
                            <div class="recipe-time-on">
                                <!-- ì¿¡íƒ€ì„ ë¶ˆëŸ¬ì˜¤ê¸° -->
                                <span>
                                    <%= data.cookTime %>
                                </span>
                            </div>
                            ë¶„ ,
                        </div>

                        <!-- ë‚œì´ë„ -->
                        <div class="recipe-view-level">
                            ë‚œì´ë„ 
                            <!-- ë‚œì´ë„ ë¶ˆëŸ¬ì˜¤ê¸° -->
                            <%- Array(data.cookLevel + 1).join('â­') %>
                        </div>

                    </div>

                    <!-- ì†Œê°œê¸€ê³¼ ì¸ë„¤ì¼ -->
                    <div class="recipe-view-imgintro">

                        <!-- ì¸ë„¤ì¼ -->
                        <div class="recipe-view-thumb">
                            <img src="/images/recipeDefault.png">
                        </div>

                        <!-- ì†Œê°œê¸€ -->
                        <div class="recipe-view-intro">
                            <!-- ì†Œê°œê¸€ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° -->
                            <%= data.intro %>
                        </div>

                    </div>

                    <!-- ì¬ë£Œ -->
                    <div class="recipe-view-ingredients">
                        
                        <!-- ì¬ë£Œ íƒ€ì´í‹€ -->
                        <div class="view-ingredients-title">
                            ì¬ë£Œ
                        </div>

                        <!-- ì¬ë£Œë“¤ -->
                        <div class="view-ingredients-box">
                            <% ingredientList.forEach((ingr, index)=>{ %>
                                <!-- ì¬ë£Œ í•˜ë‚˜ -->
                                <div class="view-ingredient">

                                    <!-- ì¬ë£Œ ì´ë¦„ ë¶ˆëŸ¬ì˜¤ê¸° -->
                                    <span class="view-ingr"><%= ingr.name %></span>

                                    <!-- ì¬ë£Œ ì–‘ ë¶ˆëŸ¬ì˜¤ê¸° -->
                                    <span class="view-quan"><%= ingr.amount %>, </span>
                                </div>
                            <% }) %>
                        </div>

                    </div>

                    <!-- ë‹¨ê³„ -->
                    <div class="recipe-view-steps">

                        <!-- ë‹¨ê³„ íƒ€ì´í‹€ -->
                        <div class="view-steps-title">
                            ìš”ë¦¬
                            <br>ê³¼ì •
                        </div>

                        <!-- ë‹¨ê³„ë“¤ -->
                        <div class="view-steps-box">
                            <% stepList.forEach((step, index)=> { %>
                                <!-- ë‹¨ê³„ í•˜ë‚˜ -->
                                <div class="view-step">
                                    <!-- âœ”ï¸ -->
                                    <div class="chkchk" style="font-weight: 800;"><%= step.step_no %>. </div>
                                    
                                    
                                    <!-- ë‹¨ê³„ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° -->
                                    <%= step.content %>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                </div>
                
                
                <!-- ì¶”ì²œ, ìŠ¤í¬ë©í•˜ê¸° -->
                <% if(typeof user != "undefined"){ %>
                    <!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ì‹œ -->
                    <div class="upscrap-box">
                        <button id="likeButton" name="login" value="ì¢‹ì•„ìš”" onClick="handleLikeButtonClick();">â¤ï¸</button>
                        <p id="likeState">  <%= likeInfo.isLiked %>  </p>
                    </div>
                <% } else{ %>
                    <!-- ë¹„ë¡œê·¸ì¸ -->
                    <div class="upscrap-box">
                        <button name="login"  onClick="alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');">ğŸ©¶</button>
                    </div>
                <% } %>
    
                <!-- ê¸€ í•˜ë‹¨ -->
                <div class="bottom-nav">
                    <div class="goback">
                        <a href="/recipe/list">ğŸ”™ ëª©ë¡ìœ¼ë¡œ</a>
                    </div>
    
                    <!-- ë¡œê·¸ì¸í•œ ìœ ì €ê°€ ê¸€ ì‘ì„±ìì¼ë•Œ ë³´ì´ê¸° -->
                    <% if(typeof user != "undefined" && user.mem_id == data.writer_id) { %>
                        <div class="editbox">
                            <ul>
                                <li>
                                    <span>
                                        <!-- ê¸€ ì‘ì„±ìì´ë©´ ê²Œì‹œê¸€ ìˆ˜ì • í˜ì´ì§€ë¡œ ì´ë™ -->
                                        <a>ìˆ˜ì •</a>
                                    </span>
                                </li>
                                <li>
                                    <span>
                                        <!-- ê¸€ ì‘ì„±ìì´ë©´ ê²Œì‹œê¸€ ì‚­ì œ -->
                                        <a>ì‚­ì œ</a>
                                        <!-- `/recipe/delete?no=${data.recipe_id}` -->
                                    </span>
                                </li>
                            </ul>
                        </div>
                    <% } %>

                </div>       
                        </span>
                    </li>
                </ul>
            </div>
            <div>
                menu ìŒì‹ ì´ë¦„; ëœì¥ì°Œê°œ ë“±ë“± <br>
                titleì€ 'ì˜¤ëŠ˜ì˜ ë©”ë‰´ ëœì¥ì°Œê°œ!!'' ì´ëŸ°ëŠê¹€<br>
                cooktime ì¡°ë¦¬ì‹œê°„<br>
                level ìŒì‹ ë‚œì´ë„ â­â­â­â­â­ë¡œ í‘œì‹œ<br>
            </div>

        </div>

        
        <!-- ëŒ“ê¸€ ë¶€ë¶„ -->
        <div class="comment-section">
            <a name="comment">
                <div class="comment-view">
                    <div class="comment-title">
                        <!-- ê´„í˜¸ ì•ˆì— ëŒ“ê¸€ìˆ˜ í‘œì‹œ -->
                        ğŸ—¨ï¸ëŒ“ê¸€(<%= commentInfo.count%>)
                    </div>
                </div>
                <!-- ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ì„ ê²½ìš° -->
                    <% if (commentInfo.dataList == ''){ %>
                        <div class="comment-view">
                            <div class="comment-page"></div>
                        </div>
                        <div class="comment-list">
                                <div class class="com-namentime">
                                    ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”!! 
                                </div>
                        </div>
                    <% } else { %>
                        <div class="comment-view">
                            <div class="comment-page">
                                <!-- ëŒ“ê¸€ í˜ì´ì§€, ëŒ“ê¸€ì´ 20ê°œ ì´ìƒì¼ ë•Œ 1,2... í˜ì´ì§€ ë‚˜íƒ€ë‚˜ê¸°. ì•„ë˜ëŠ” ì˜ˆì‹œ -->
                                <% if(commentInfo.pagination.pageNo!=1){ %>
                                    <a id="prev-a" href="javascript:void(0);" data-page="<%= commentInfo.pagination.pageNo-1 %>" onclick="comPageClick(this.dataset.page)" >&nbsp;&lt;&nbsp;</a>
                                <% } %>
                                <% for (var i = commentInfo.pagination.startPage; i < commentInfo.pagination.endPage + 1; i++){ %>
                                        <% if (commentInfo.pagination.pageNo == i){ %> 
                                            <a href="javascript:void(0);"class="number-button" data-page="<%= i %>" style="font-weight: 800;" onclick="comPageClick(this.dataset.page)">&nbsp;<%= i %>&nbsp;</a>
                                        <% } else { %>
                                            <a href="javascript:void(0);"class="number-button" data-page="<%= i %>" onclick="comPageClick(this.dataset.page)">&nbsp;<%= i %>&nbsp;</a>
                                        <% } %>
                                <% } %>
                                <% if (commentInfo.pagination.pageNo != commentInfo.pagination.totalPage){ %>
                                    <a id="next-a" href="javascript:void(0);" data-page="<%= commentInfo.pagination.startPage-1 %>" onclick="comPageClick(this.dataset.page)">&nbsp;&gt;&nbsp;</a>
                                <% } %>
                            </div>
                        </div>
                        
                        <div class="comment-list">
                            <% commentInfo.dataList.forEach((comment, index)=>{ %>
                                <div class="com-namentime">
                                    <div class="com-name">
                                        <!-- ëŒ“ê¸€ ì‘ì„±ì ì´ë¦„ -->
                                        <%= comment.mem_id %>
                                    </div>
                                    <div class="com-time">
                                        <!-- ëŒ“ê¸€ì´ ì‘ì„±ëœ ì‹œê°„ -->
                                        (<%= comment.createdAt.toISOString().split('T')[0] %>
                                        <%= comment.createdAt.toISOString().split('T')[1].slice(0,5) %>)
                                    </div>

                                    <!-- ê¸€ ì—´ëŒ ìœ ì € = ëŒ“ê¸€ ì‘ì„±ìì´ë©´ ë³´ì´ê¸° -->
                                    <div class="com-editbox">
                                        <span>ìˆ˜ì •</span>
                                        <span>ì‚­ì œ</span>
                                    </div>
                                    
                                </div>
                                <div class="com-text">
                                    <!-- ëŒ“ê¸€ ë‚´ìš© -->
                                    <%= comment.content %>
                                </div>
                                <% }); %>
                        </div>
                    <% } %>


                <!-- ëŒ“ê¸€ ë‹¬ê¸° -->
                <% if(typeof user != "undefined"){ %>
                    <!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ì‹œ -->
                    <div class="comment-write">
                        <div class="comment-write-form">    
                            <!--  âš ï¸âš ï¸ í¼ íƒœê·¸ ë°”ê¿ˆ. 231109 -->
                            <div class="commenter">
                                <!-- ìœ ì € ë‹‰ë„¤ì„ -->
                                <%= user.mem_id %>
                            </div>
                            <form id="commentForm">
                                <div class="comment-write-section">
                                    <div class="write-comment">
                                        <textarea id="comment-textarea" name="content" placeholder="ê³ ìš´ë§ ëŒ“ê¸€ ë‹¬ê¸°" required></textarea>
                                    </div>
                                    <div class="submit-button">
                                        <button type="submit" name="submit">ë“±ë¡</button>
                                    </div>
                                </div>
                            </form> 
                        </div>
                    </div>
                <% } else{ %>
                    <!-- ë¹„ë¡œê·¸ì¸ -->
                    <div class="non-user-comment">
                        <textarea onclick="confirm('ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!');" placeholder="ë¡œê·¸ì¸í•˜ê³  ëŒ“ê¸€ì„ ë‹¬ì•„ë³´ì„¸ìš”!" required></textarea>
                    </div>
                <% } %>

                <!-- í•˜ë‹¨ -->
                <div class="box">
                    <button onclick="location.href='/recipe/list'">ê¸€ëª©ë¡</button>
                </div>
            </a>
        </div>
        <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” -->
        <div class="sidebar-section">
            <div class="sidebar-box-right">
                <!-- headerë¡œ -->
                <a href="#up-scroll">â–²</a>
                <!-- footerë¡œ -->
                <a href="#down-scroll">â–¼</a>
                <!-- ëŒ“ê¸€ë¡œ -->
                <a href="#comment">ğŸ—¨ï¸</a>
            </div>
        </div>

    </div>
</section>


<script>
    const _recipeId = JSON.parse('<%= data.recipe_id %>');
    if ('<%= likeInfo.isLiked %>'){
        var isLiked = JSON.parse('<%= likeInfo.isLiked %>');
        console.log(isLiked,'ëŒ€ì²´ ì™œ');
    }  
    const numberWrapper = document.getElementsByClassName('number-button-wrapper')[0];
    
    function handleLikeButtonClick() {
        console.log('recipeId: ', _recipeId, isLiked);
        console.log(isLiked, 'ì¢‹ì•„ìš” ëˆ„ë¦„ ìƒíƒœ');  
        // console.log('ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­');
        if(isLiked){
            isLiked--;
        } else{
            isLiked++;
        } 
        // //AJAX ìš”ì²­
        // const likeButton = document.getElementById("likeButton").a
        fetch(`/recipe/like`, {   //`/recipe/view?no=${_recipeId}`
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({recipeId: _recipeId, isLiked: isLiked}) // postidë¥¼ ì„œë²„ë¡œ ì „ì†¡
        })
        .then(response => response.json())
        .then(data=>{
            console.log('ì„œë²„ ì‘ë‹µ-ìœ ì € ì¢‹ì•„ìš” ìƒíƒœ: ', data.isLiked);
            console.log('ì„œë²„ ì‘ë‹µ-ì¢‹ì•„ìš” ìˆ˜ : ', data.likeCount);
            document.getElementById('like').innerHTML=data.likeCount;
            document.getElementById('likeState').innerHTML = data.isLiked;
            // data.
            
            //ì„œë²„ì—ì„œ ë°›ì€ ì‘ë‹µì— ë”°ë¼ í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì²˜ã…£ã„¹
            if(data.success){
                // ì¢‹ì•„ìš” ë°˜ì˜ ì„±ê³µ => ì´ë¯¸ì§€ ë³€ê²½
                console.log('ì¢‹ì•„ìš” success..!', data.isLiked);
                if(data.isLiked)
                    alert(data.message);
                else
                    alert('ì¢‹ì•„ìš”ë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤!');
            } else {
                //ì‹¤íŒ¨
                console.log('failed..!');
            }

        })
        .catch((error)=>{
            console.error('ì—ëŸ¬ë°œìƒ: ', error.message);
        });
    }

    document.getElementById("commentForm").addEventListener("submit", function (event) {
        event.preventDefault(); // a, submit íƒœê·¸ í´ë¦­ ì‹œ, ì°½ ì´ë™, ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰ë¨. ê·¸ ë™ì‘ ë°©ì§€.
        const formData = new FormData(event.target);
        const content = formData.get("content");
        // console.log('[recipeView.ejs] recipeIdë‘ content', _recipeId, content);
        
        fetch(`/recipe/newComment?no=<%= data.recipe_id %>&sort=earliest`, {   //`/recipe/view?no=${_recipeId}`
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({recipeId: _recipeId, content: content}) // postidë¥¼ ì„œë²„ë¡œ ì „ì†¡
        })
        .then(response=> response.json())
        .then(data=>{
            document.getElementById("comment-textarea").value ="";
            // fetchData í˜¸ì¶œí•˜ê¸°
            fetchCommentData(data.page);    ///ëŒ“ê¸€ ë§ˆì§€ë§‰ í˜ì´ì§€ë§Œ ê°€ì ¸ì™€ì„œ ì „ë‹¬
            // console.log('[ì„œë²„ ì‘ë‹µ]: ',data);
        })
        .catch(error=>{
            console.log('[Error]: While fetching newComment', error);
            document.getElementById("comment-textarea").value ="";
        })
    })

    
        // getElementsByClassName("")[index]. ë¡œ ê° í˜ì´ì§€ ë²„íŠ¼ ì ‘ê·¼í•˜ì
    // í•˜í•˜, ì´ê±¸ ì°¸ ì–´ë–»ê²Œ í•´ì•¼í• ì§€. ëŒ“ê¸€ ì‘ì„±í•˜ê³  ëŒ“ê¸€ í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸í•˜ë©´ ì¢€ ì¤‘ë³µì´ì–ì•„
    async function fetchCommentData(page){
        // test í˜ì´ì§€ë„¤ì´ì…˜ì´ë‘ ë°ì´í„° ëª©ë¡ ë³€ê²½ í™•ì¸
        try{
            const response = await fetch(`/recipe/getComment?no=${_recipeId}&pageno=${page}&sort=earliest`);
            const data = await response.json();
            const pagination = data.commentInfo.pagination;
            const dataList = data.commentInfo.dataList;
            const comPageDiv = document.getElementsByClassName("comment-page")[0];
            const comListDiv = document.getElementsByClassName("comment-list")[0];
            var contentPage = '';
            var contentComment = '';
            //ğŸ’š <  > í‘œì‹œ í™•ì¸.
            
            if(pagination.pageNo>1){  // 1í˜ì´ì§€ ì œì™¸ < í‘œì‹œ
                contentPage += `<a id="prev-a" href="javascript:void(0);" data-page="${pagination.pageNo-1}" onclick="comPageClick(this.dataset.page)" >&nbsp;&lt;&nbsp;</a>`;
            }
            for (var i= pagination.startPage; i<pagination.endPage + 1; i++){
                if (pagination.pageNo == i){
                    contentPage += `<a href="javascript:void(0);"class="number-button" data-page="${i}" style="font-weight: 800;" onclick="comPageClick(this.dataset.page)">&nbsp;${i}&nbsp;</a>`;
                } else{
                    contentPage += `<a href="javascript:void(0);"class="number-button" data-page="${i}" onclick="comPageClick(this.dataset.page)">&nbsp;${i}&nbsp;</a>`;
                }
            }
            if(pagination.pageNo<pagination.totalPage){
                contentPage += `<a id="next-a" href="javascript:void(0);" data-page="${pagination.pageNo+1}" onclick="comPageClick(this.dataset.page)">&nbsp;&gt;&nbsp;</a>`;
            }
            comPageDiv.innerHTML = contentPage;

            // ğŸ—¨ï¸ ëŒ“ê¸€ í‘œì‹œ
            try{
                    comListDiv.innerText="";    //ì´ê±° ìˆœì„œë‘ ì‹œê°„ ë‚ ì§œ ë•Œë¬¸ì— ì•ˆëì—ˆë‹¤ã…ã…ì•™ ì‹œê°„ ë‚ ì§œ ë•œì— ëŒ“ê¸€ì´ ì•„ì´ë””ë§Œ í‘œì‹œë¨
            // div.comment-list>div.com-namentime>div.com-name + div.com-time
            //                  div.com-content
                dataList.forEach((data, index)=>{
                    // contentComment = 
                    let nameNTimeDiv = document.createElement('div');
                    nameNTimeDiv.setAttribute("class", "com-namentime");

                    let nameDiv = document.createElement('div');
                    nameDiv.setAttribute("class", "com-name");
                    let timeDiv = document.createElement('div');
                    timeDiv.setAttribute("class", "com-time");

                    let textDiv = document.createElement('div');
                    textDiv.setAttribute("class", "com-text");

                    // div í•©ì²´!!!
                    nameNTimeDiv.append(nameDiv, timeDiv);
                    comListDiv.append(nameNTimeDiv, textDiv);

                    nameDiv.innerText = data.mem_id;
                    timeDiv.innerText = '('+data.createdAt.slice(0,10) + ' ' + data.createdAt.slice(11,16)+')';//'(' + data.createdAt.toISOString().split('T')[0] + data.createdAt.toISOString().split('T')[1].slice(0,5) + ')';
                    textDiv.innerText = data.content;
                    // comListDiv.appendChild
            })
        } catch(err){
            console.log('Error: while updating comments list', err.message);
        }

        } catch (err){
            console.log('[Error]: boardPost.ejs-fetchData and Pagination', err);
        }
    }

    function comPageClick(page){
        // fetch í•¨ìˆ˜ì— í˜„ì¬ í˜ì´ì§€ ê°’ ì „ì†¡
        fetchCommentData(page);
    }

</script>